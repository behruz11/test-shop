name: Werf deploy

env:
  WERF_ENV: development
  WERF_NAMESPACE: default
  WERF_REPO: ${{ secrets.ECR_LOGIN }}/opencesear
  WERF_SECRET_KEY: ${{ secrets.WERF_SECRET_KEY }}
  WERF_USERNAME: ${{ secrets.ECR_LOGIN }}
  WERF_PASSWORD: ${{ secrets.ECR_PASSWORD }}
  WERF_VALUES_ENV: .helm/values-envs.yaml
  WERF_SECRET_VALUES_ENV: .helm/secret-values.yaml
  # WERF_KUBECONFIG_BASE64: ${{ secrets.KUBE_CONFIG_BASE64_DATA }}
  
on:
  push:
    branches:
      - "actions"

jobs:
  build:
    runs-on: [self-hosted, jenkinsdevops]
    steps:        
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # - name: Install werf
      #   uses: werf/actions/install@v1.2
        
      # - name: Run script for depoying to kubernetes
      #   run: |
      #     echo "${{ github.workspace }}"
      #     # . $(werf ci-env github --as-file)
      #     source $("/home/deployer/bin/trdl" use werf "1.2" "stable")
      #     werf cr login index.docker.io #-u ${{ secrets.ECR_LOGIN }} -p ${{ secrets.ECR_PASSWORD }} index.docker.io
      #     werf converge #--repo ${{ secrets.ECR_LOGIN }}/opencesear --env development

      - name: Converge
        uses: werf/actions/converge@v1.2
        with:
          env: development
          kube-config-base64-data: ${{ secrets.KUBE_CONFIG_BASE64_DATA }}
          
        env:
          WERF_ENV: development
          WERF_VALUES_ENV: .helm/values-envs.yaml
          WERF_RELEASE: "test-shop"
          WERF_SET_INGRESS_ENABLED: "apps-ingresses.test-shop.enabled=true"
          WERF_SET_STS_APP_ENABLED: "apps-stateless.super-redis.enabled=true"
          WERF_SET_CM_ENABLED: "apps-configmaps.service-env-configmap.enabled=true"
          WERF_SET_SECRET_ENABLED: "apps-secrets.service-env-secret.enabled=true"
          WERF_SET_ENV_URL: "global.envUrl=opensearch.alif.pk"
